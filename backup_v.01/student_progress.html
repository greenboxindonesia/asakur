<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Progress Saya - ASAKUR</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary-blue: #0d3b66;
      --secondary-blue: #1a5f7a;
      --accent-blue: #2a9d8f;
      --sidebar-width: 280px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fb;
      color: #333;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: linear-gradient(180deg, var(--primary-blue) 0%, #023047 100%);
      color: white;
      padding: 25px 0;
      z-index: 1000;
      box-shadow: 5px 0 25px rgba(0, 0, 0, 0.15);
    }
    
    .sidebar-brand {
      padding: 0 25px 30px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 25px;
    }
    
    .sidebar-brand h3 {
      font-weight: 700;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0 15px;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      color: rgba(255, 255, 255, 0.85);
      text-decoration: none;
      border-radius: 12px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .sidebar-menu a:hover, .sidebar-menu a.active {
      background-color: rgba(255, 255, 255, 0.15);
      transform: translateX(5px);
    }
    
    .sidebar-menu i {
      width: 25px;
      margin-right: 15px;
    }
    
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 30px;
      min-height: 100vh;
    }
    
    .page-header {
      background: white;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
      margin-bottom: 30px;
    }
    
    .content-card {
      background: white;
      border-radius: 18px;
      padding: 35px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
      margin-bottom: 30px;
    }
    
    .score-card {
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
      color: white;
      border-radius: 18px;
      padding: 30px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    
    .score-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }
    
    .score-card h3 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .progress-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0 auto 20px;
      position: relative;
    }
    
    .progress-circle.high {
      background: conic-gradient(#28a745 0% var(--percentage), #e9ecef var(--percentage) 100%);
    }
    
    .progress-circle.medium {
      background: conic-gradient(#ffc107 0% var(--percentage), #e9ecef var(--percentage) 100%);
    }
    
    .progress-circle.low {
      background: conic-gradient(#dc3545 0% var(--percentage), #e9ecef var(--percentage) 100%);
    }
    
    .progress-circle::before {
      content: '';
      position: absolute;
      width: 120px;
      height: 120px;
      background: white;
      border-radius: 50%;
    }
    
    .progress-text {
      position: relative;
      z-index: 1;
      color: var(--primary-blue);
    }
    
    .assessment-item {
      border-left: 4px solid var(--accent-blue);
      padding: 20px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .assessment-item:hover {
      background: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .badge {
      padding: 8px 18px;
      border-radius: 30px;
      font-weight: 500;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    @media (max-width: 992px) {
      .main-content {
        margin-left: 0;
      }
      
      .sidebar {
        transform: translateX(-100%);
      }
    }
  </style>
</head>
<body>

<nav class="sidebar">
  <div class="sidebar-brand">
    <h3><i class="fas fa-hands-helping"></i> ASAKUR</h3>
    <p style="font-size: 0.85rem; opacity: 0.8;">Mahasiswa Panel</p>
  </div>
  
  <ul class="sidebar-menu">
    <li><a href="#" onclick="navigateToPage('student'); return false;">
      <i class="fas fa-home"></i> Dashboard
    </a></li>
    
    <li><a href="#" onclick="navigateToPage('student_appointments'); return false;">
      <i class="fas fa-calendar-alt"></i> Jadwal Konseling
    </a></li>
    
    <li><a href="#" onclick="navigateToPage('student_counselors'); return false;">
      <i class="fas fa-user-md"></i> Cari Konselor
    </a></li>
    
    <li><a href="#" class="active" onclick="navigateToPage('student_progress'); return false;">
      <i class="fas fa-chart-line"></i> Progress Saya
    </a></li>
    
    <li><a href="#" onclick="navigateToPage('student_profile'); return false;">
      <i class="fas fa-user-cog"></i> Profil Saya
    </a></li>
  </ul>
  
  <div style="position: absolute; bottom: 30px; left: 0; right: 0; padding: 0 25px;">
    <a href="#" onclick="logout(); return false;" style="background-color: rgba(255, 255, 255, 0.1);">
      <i class="fas fa-sign-out-alt"></i> Logout
    </a>
  </div>
</nav>

<div class="main-content">
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1><i class="fas fa-chart-line me-3"></i> Progress Kesehatan Mental Saya</h1>
        <p class="text-muted mb-0">Pantau perkembangan kesehatan mental Anda</p>
      </div>
      <button class="btn btn-primary btn-lg" onclick="downloadReport()">
        <i class="fas fa-download me-2"></i> Download Laporan
      </button>
    </div>
  </div>
  
  <!-- Current Status -->
  <div class="row">
    <div class="col-lg-4">
      <div class="score-card">
        <div class="text-center">
          <i class="fas fa-heart fa-3x mb-3"></i>
          <h3 id="totalScore">0</h3>
          <p class="mb-0">Skor Kesehatan Mental</p>
          <small id="lastAssessmentDate">Terakhir: -</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="content-card">
        <h5 class="text-center mb-3">Tingkat Risiko</h5>
        <div class="progress-circle" id="riskCircle" style="--percentage: 0%">
          <div class="progress-text">0%</div>
        </div>
        <p class="text-center">
          <span class="badge" id="riskBadge">-</span>
        </p>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="content-card">
        <h5 class="mb-4"><i class="fas fa-trophy me-2 text-warning"></i> Pencapaian</h5>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-2">
            <span>Total Sesi</span>
            <strong id="totalSessions">0</strong>
          </div>
          <div class="progress">
            <div class="progress-bar bg-success" id="sessionProgress" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-2">
            <span>Total Asesmen</span>
            <strong id="totalAssessments">0</strong>
          </div>
          <div class="progress">
            <div class="progress-bar bg-info" id="assessmentProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Detailed Scores -->
  <div class="row">
    <div class="col-lg-8">
      <div class="content-card">
        <h4 class="mb-4"><i class="fas fa-chart-area me-2"></i> Grafik Progress</h4>
        <div class="chart-container">
          <canvas id="progressChart"></canvas>
        </div>
      </div>
      
      <div class="content-card">
        <h4 class="mb-4"><i class="fas fa-history me-2"></i> Riwayat Asesmen</h4>
        <div id="assessmentHistory">
          <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Memuat riwayat asesmen...</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <!-- Component Scores -->
      <div class="content-card">
        <h4 class="mb-4"><i class="fas fa-star me-2"></i> Skor Komponen</h4>
        
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span><i class="fas fa-heart text-danger me-2"></i>Gratitude</span>
            <strong id="gratitudeScore">0</strong>
          </div>
          <div class="progress">
            <div class="progress-bar bg-danger" id="gratitudeProgress" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span><i class="fas fa-hands-helping text-success me-2"></i>Compassion</span>
            <strong id="compassionScore">0</strong>
          </div>
          <div class="progress">
            <div class="progress-bar bg-success" id="compassionProgress" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span><i class="fas fa-shield-alt text-warning me-2"></i>Suicidal (Inverted)</span>
            <strong id="suicidalScore">0</strong>
          </div>
          <div class="progress">
            <div class="progress-bar bg-warning" id="suicidalProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
      
      <!-- Recommendations -->
      <div class="content-card">
        <h4 class="mb-4"><i class="fas fa-lightbulb me-2"></i> Rekomendasi</h4>
        <div id="recommendations">
          <div class="alert alert-info">
            <small>Lakukan asesmen untuk mendapat rekomendasi personal</small>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="content-card">
        <h4 class="mb-4"><i class="fas fa-bolt me-2"></i> Aksi Cepat</h4>
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" onclick="navigateToPage('student_appointments')">
            <i class="fas fa-calendar-plus me-2"></i> Jadwal Sesi
          </button>
          <button class="btn btn-outline-success" onclick="viewResources()">
            <i class="fas fa-book me-2"></i> Materi Bantuan
          </button>
          <button class="btn btn-outline-danger" onclick="triggerEmergency()">
            <i class="fas fa-phone-alt me-2"></i> Kontak Darurat
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Logout Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-4">Sedang logout...</h5>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let baseUrl = '';
let studentAssessments = [];
let studentSessions = [];
let progressChart = null;

document.addEventListener('DOMContentLoaded', function() {
  google.script.run
    .withSuccessHandler(function(url) {
      baseUrl = url;
      loadProgressData();
    })
    .getWebAppUrl();
});

function navigateToPage(pageName) {
  if (!baseUrl) return;
  window.top.location.href = baseUrl + '?page=' + pageName;
}

function loadProgressData() {
  google.script.run
    .withSuccessHandler(function(session) {
      if (session && session.role === 'student') {
        loadAssessments(session.id);
        loadSessions(session.id);
      } else {
        navigateToPage('student');
      }
    })
    .getSession();
}

function loadAssessments(studentId) {
  google.script.run
    .withSuccessHandler(function(assessments) {
      studentAssessments = assessments;
      displayCurrentStatus(assessments);
      displayAssessmentHistory(assessments);
      createProgressChart(assessments);
      generateRecommendations(assessments);
    })
    .getStudentAssessments(studentId);
}

function loadSessions(studentId) {
  google.script.run
    .withSuccessHandler(function(sessions) {
      studentSessions = sessions;
      updateSessionStats(sessions);
    })
    .getStudentSessions(studentId);
}

function displayCurrentStatus(assessments) {
  if (!assessments || assessments.length === 0) {
    document.getElementById('totalScore').textContent = '-';
    document.getElementById('lastAssessmentDate').textContent = 'Belum ada asesmen';
    return;
  }
  
  const latest = assessments[0];
  const totalScore = latest.total_score || 0;
  
  document.getElementById('totalScore').textContent = totalScore;
  
  const date = new Date(latest.assessment_date);
  document.getElementById('lastAssessmentDate').textContent = 
    'Terakhir: ' + date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
  
  // Risk level
  const riskLevel = getRiskLevel(totalScore);
  const riskCircle = document.getElementById('riskCircle');
  const riskBadge = document.getElementById('riskBadge');
  
  riskCircle.className = 'progress-circle ' + riskLevel.class;
  riskCircle.style.setProperty('--percentage', totalScore + '%');
  riskCircle.querySelector('.progress-text').textContent = totalScore + '%';
  
  riskBadge.className = 'badge bg-' + riskLevel.color;
  riskBadge.textContent = riskLevel.level;
  
  // Component scores
  document.getElementById('gratitudeScore').textContent = latest.gratitude_score || 0;
  document.getElementById('compassionScore').textContent = latest.compassion_score || 0;
  document.getElementById('suicidalScore').textContent = (100 - (latest.suicidal_score || 0));
  
  document.getElementById('gratitudeProgress').style.width = (latest.gratitude_score || 0) + '%';
  document.getElementById('compassionProgress').style.width = (latest.compassion_score || 0) + '%';
  document.getElementById('suicidalProgress').style.width = (100 - (latest.suicidal_score || 0)) + '%';
}

function displayAssessmentHistory(assessments) {
  const container = document.getElementById('assessmentHistory');
  
  if (!assessments || assessments.length === 0) {
    container.innerHTML = `
      <div class="text-center py-4">
        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
        <p>Belum ada riwayat asesmen</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  
  assessments.forEach((assessment, index) => {
    const date = new Date(assessment.assessment_date);
    const formattedDate = date.toLocaleDateString('id-ID', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
    
    const riskLevel = getRiskLevel(assessment.total_score);
    
    container.innerHTML += `
      <div class="assessment-item">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h6 class="mb-1">Asesmen #${assessments.length - index}</h6>
            <small class="text-muted">${formattedDate} - ${assessment.counselor_name || 'Konselor'}</small>
          </div>
          <span class="badge bg-${riskLevel.color}">${assessment.total_score}</span>
        </div>
        
        <div class="row mt-3">
          <div class="col-4">
            <small class="text-muted">Gratitude</small>
            <div class="fw-bold">${assessment.gratitude_score || 0}</div>
          </div>
          <div class="col-4">
            <small class="text-muted">Compassion</small>
            <div class="fw-bold">${assessment.compassion_score || 0}</div>
          </div>
          <div class="col-4">
            <small class="text-muted">Suicidal</small>
            <div class="fw-bold">${assessment.suicidal_score || 0}</div>
          </div>
        </div>
        
        ${assessment.notes ? `
          <div class="mt-2">
            <small class="text-muted">Catatan: ${assessment.notes}</small>
          </div>
        ` : ''}
      </div>
    `;
  });
  
  document.getElementById('totalAssessments').textContent = assessments.length;
  document.getElementById('assessmentProgress').style.width = 
    Math.min(100, (assessments.length / 10) * 100) + '%';
}

function createProgressChart(assessments) {
  console.log('Creating progress chart with assessments:', assessments);
  
  const ctx = document.getElementById('progressChart');
  if (!ctx) {
    console.error('Canvas element not found');
    return;
  }
  
  if (!assessments || assessments.length === 0) {
    console.log('No assessments data, showing empty state');
    ctx.getContext('2d').fillText('Belum ada data asesmen', 200, 150);
    return;
  }
  
  // Sort by date (oldest first for chart)
  const sorted = [...assessments].sort((a, b) => 
    new Date(a.assessment_date) - new Date(b.assessment_date)
  );
  
  const labels = sorted.map((a, i) => {
    const date = new Date(a.assessment_date);
    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
  });
  
  const gratitudeData = sorted.map(a => a.gratitude_score || 0);
  const compassionData = sorted.map(a => a.compassion_score || 0);
  const totalData = sorted.map(a => a.total_score || 0);
  
  // Destroy existing chart if any
  if (window.progressChart instanceof Chart) {
    window.progressChart.destroy();
  }
  
  window.progressChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Total Score',
          data: totalData,
          borderColor: '#0d3b66',
          backgroundColor: 'rgba(13, 59, 102, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        },
        {
          label: 'Gratitude',
          data: gratitudeData,
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4,
          borderWidth: 2
        },
        {
          label: 'Compassion',
          data: compassionData,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          tension: 0.4,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15
          }
        },
        title: {
          display: false
        },
        tooltip: {
          mode: 'index',
          intersect: false,
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 20
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    }
  });
  
  console.log('Chart created successfully');
}

function updateSessionStats(sessions) {
  const total = sessions.length;
  document.getElementById('totalSessions').textContent = total;
  document.getElementById('sessionProgress').style.width = 
    Math.min(100, (total / 20) * 100) + '%';
}

function generateRecommendations(assessments) {
  const container = document.getElementById('recommendations');
  
  if (!assessments || assessments.length === 0) {
    return;
  }
  
  const latest = assessments[0];
  const riskLevel = getRiskLevel(latest.total_score);
  
  let recommendations = '';
  
  if (riskLevel.level === 'Tinggi') {
    recommendations = `
      <div class="alert alert-danger">
        <h6 class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Perhatian Khusus</h6>
        <ul class="mb-0 ps-3 small">
          <li>Segera jadwalkan sesi dengan konselor</li>
          <li>Hubungi kontak darurat jika merasa tidak aman</li>
          <li>Praktikkan teknik grounding dan mindfulness</li>
          <li>Hindari isolasi, hubungi teman/keluarga</li>
        </ul>
      </div>
    `;
  } else if (riskLevel.level === 'Sedang') {
    recommendations = `
      <div class="alert alert-warning">
        <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Perlu Perhatian</h6>
        <ul class="mb-0 ps-3 small">
          <li>Lanjutkan sesi konseling rutin</li>
          <li>Praktikkan gratitude journaling setiap hari</li>
          <li>Tingkatkan self-compassion exercises</li>
          <li>Jaga pola tidur dan makan teratur</li>
        </ul>
      </div>
    `;
  } else {
    recommendations = `
      <div class="alert alert-success">
        <h6 class="mb-2"><i class="fas fa-check-circle me-2"></i>Kondisi Baik</h6>
        <ul class="mb-0 ps-3 small">
          <li>Pertahankan praktik gratitude harian</li>
          <li>Terus kembangkan compassion untuk diri sendiri</li>
          <li>Bantu sesama yang membutuhkan</li>
          <li>Lakukan aktivitas yang Anda nikmati</li>
        </ul>
      </div>
    `;
  }
  
  container.innerHTML = recommendations;
}

function getRiskLevel(score) {
  if (score >= 80) {
    return { level: 'Rendah', color: 'success', class: 'high' };
  } else if (score >= 60) {
    return { level: 'Sedang', color: 'warning', class: 'medium' };
  } else {
    return { level: 'Tinggi', color: 'danger', class: 'low' };
  }
}

function downloadReport() {
  // Instead of showing "under development", let's create a simple text report
  if (!studentAssessments || studentAssessments.length === 0) {
    showNotification('Belum ada data untuk di-download', 'warning');
    return;
  }
  
  let reportText = 'LAPORAN PROGRESS KESEHATAN MENTAL - ASAKUR\n';
  reportText += '='.repeat(50) + '\n\n';
  reportText += `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n`;
  reportText += `Nama: ${currentSession ? currentSession.fullname : ''}\n\n`;
  reportText += 'RIWAYAT ASESMEN:\n';
  reportText += '-'.repeat(50) + '\n';
  
  studentAssessments.forEach((assessment, index) => {
    const date = new Date(assessment.assessment_date);
    reportText += `\n${index + 1}. ${date.toLocaleDateString('id-ID')}\n`;
    reportText += `   Gratitude: ${assessment.gratitude_score}\n`;
    reportText += `   Compassion: ${assessment.compassion_score}\n`;
    reportText += `   Suicidal: ${assessment.suicidal_score}\n`;
    reportText += `   Total Score: ${assessment.total_score}\n`;
    reportText += `   Konselor: ${assessment.counselor_name || 'N/A'}\n`;
    if (assessment.notes) {
      reportText += `   Catatan: ${assessment.notes}\n`;
    }
  });
  
  // Create download
  const blob = new Blob([reportText], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Laporan_Progress_${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  showNotification('Laporan berhasil di-download', 'success');
}

function viewResources() {
  // Create a modal with mental health resources
  const resourcesHTML = `
    <div class="modal fade" id="resourcesModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-book me-2"></i> Materi Bantuan Kesehatan Mental</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <h6 class="mb-3">Teknik Self-Care:</h6>
            <ul>
              <li><strong>Gratitude Journaling:</strong> Tulis 3 hal yang Anda syukuri setiap hari</li>
              <li><strong>Mindfulness Meditation:</strong> Luangkan 10 menit untuk meditasi pernapasan</li>
              <li><strong>Self-Compassion:</strong> Perlakukan diri sendiri dengan kebaikan</li>
              <li><strong>Physical Exercise:</strong> Olahraga ringan 30 menit per hari</li>
            </ul>
            
            <h6 class="mb-3 mt-4">Kontak Darurat:</h6>
            <div class="alert alert-info">
              <p class="mb-1"><strong>Hotline Crisis:</strong> 119</p>
              <p class="mb-1"><strong>Mental Health Hotline:</strong> 021-500-454</p>
              <p class="mb-0"><strong>WhatsApp Konseling:</strong> 0811-1234-5678</p>
            </div>
            
            <h6 class="mb-3">Sumber Bacaan:</h6>
            <ul>
              <li>Compassion Focused Therapy (Paul Gilbert)</li>
              <li>The Gifts of Imperfection (Bren√© Brown)</li>
              <li>Radical Acceptance (Tara Brach)</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existing = document.getElementById('resourcesModal');
  if (existing) {
    existing.remove();
  }
  
  // Add modal to body
  document.body.insertAdjacentHTML('beforeend', resourcesHTML);
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('resourcesModal'));
  modal.show();
}

function triggerEmergency() {
  if (confirm('Apakah Anda dalam keadaan darurat dan membutuhkan bantuan segera?')) {
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          alert(response.message);
        }
      })
      .triggerEmergency();
  }
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);';
  notification.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 5000);
}

function logout() {
  const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
  modal.show();
  
  google.script.run
    .withSuccessHandler(function(response) {
      setTimeout(() => {
        window.top.location.href = response.redirectUrl || baseUrl;
      }, 1500);
    })
    .withFailureHandler(function(error) {
      console.error('Logout error:', error);
      setTimeout(() => {
        window.top.location.href = baseUrl;
      }, 2000);
    })
    .serverLogout();
}
</script>
</body>
</html>